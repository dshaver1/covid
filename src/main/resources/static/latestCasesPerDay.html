<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>COVID-19 Stats</title>
    <style>

        .bar {
            fill: steelblue;
            shape-rendering: crispEdges;
        }

        .deathbar:hover {
            fill: #b81200;
            shape-rendering: crispEdges;
        }

        .casebar:hover {
            fill: #8885d4;
            shape-rendering: crispEdges;
        }

        .axis {
            font: 10px sans-serif;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .grid line {
            stroke: lightgrey;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }

        .grid path {
            stroke-width: 0;
        }

        .d3-tip {
            line-height: 1;
            padding: 6px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            border-radius: 4px;
            font-size: 12px;
        }

        .dashed {
            stroke-dasharray: 5, 5;
            color: black;
        }

        .notableDates {
            font-size: smaller;
        }

    </style>

</head>
<body>
<script src="https://d3js.org/d3.v5.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>
<script src="d3-tip.js"></script>

<link
        rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous"
/>

<div class="container">
    <h2>COVID-19 Confirmed Cases Per Day In Georgia</h2>
    <div class="row align-items-center">
        <div class="col-sm-2">Current Snapshot<p id="value-time"></p></div>
        <div class="col-sm">
            <div id="slider-time"></div>
        </div>
    </div>
</div>

<script>
    d3.selection.prototype.moveToFront = function () {
        return this.each(function () {
            this.parentNode.appendChild(this);
        });
    };
</script>

<script>

    let notableDates = [{
        "date": "2020-03-14",
        "label": "Public Health State of Emergency Declared"
    }, {
        "date": "2020-03-16",
        "label": "Majority of Schools Closed"
    }, {
        "date": "2020-04-03",
        "label": "Stay-At-Home Order Began"
    }, {
        "date": "2020-05-01",
        "label": "Stay-At-Home Order Expired"
    }]

    var keys = ["Confirmed Cases", "Deaths"];
    var colors = ["#8a89a6", "#ff8c00", "#504aff", "#b81200"];

    // set the dimensions of the canvas
    var margin = {top: 0, right: 20, bottom: 120, left: 60},
        width = 1000 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom
        topSvgHeight = 100;


    // set the ranges
    var xScale = d3.scaleBand().rangeRound([0, width]);

    var yScale = d3.scaleLinear().range([height, 0]);

    // define the axis
    var xAxis = d3.axisBottom(xScale);


    var yAxis = d3.axisLeft(yScale).ticks(10);

    var topSvg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right + 400)
        .attr("height", topSvgHeight)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + 0 + ")");

    // add the SVG element
    var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    // gridlines in y axis function
    function make_y_gridlines() {
        return d3.axisLeft(yScale)
            .ticks(5)
    }

    var theData, dataTime, sliderTime, tip;

    // load the data
    d3.json("/reports/daily").then(function (data) {
        // Set slider data
        dataTime = data.map(function (d) {
            return d.reportDate;
        });

        sliderTime = d3
            .sliderBottom()
            .min(14) // Just so happens that the 14th record is the first one with data...
            .max(dataTime.length - 1)
            .step(1)
            .ticks(dataTime.length - 1 - 14)
            .width(350)
            //.tickValues(dataTime)
            .on('onchange', val => {
                d3.select('p#value-time').text(dataTime[val]);
                updateChart();
            });

        var gTime = d3
            .select('div#slider-time')
            .append('svg')
            .attr('width', 400)
            .attr('height', 100)
            .append('g')
            .attr('transform', 'translate(0,30)');

        gTime.call(sliderTime);

        d3.select('p#value-time').text(dataTime[sliderTime.value()]);

        // Do the graph!

        theData = data;
        var casesPerDay = data[data.length - 1].casesPerDay;

        // scale the range of the data
        xScale.domain(casesPerDay.map(function (d) {
            return d.label;
        }));
        yScale.domain([0, d3.max(casesPerDay, function (d) {
            return d.y;
        })]);

        // add the Y gridlines
        svg.append("g")
            .attr("class", "grid")
            .call(make_y_gridlines()
                .tickSize(-width)
                .tickFormat("")
            )

        // add axis
        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", "-.55em")
            .attr("transform", "rotate(-90)");

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 5)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Cases Per Day");

        // Legend
        var color = d3.scaleOrdinal()
            .domain(keys)
            .range(colors);

        var size = 10
        svg.selectAll("mydots")
            .data(keys)
            .enter()
            .append("rect")
            .attr("x", 100)
            .attr("y", function (d, i) {
                return 50 + i * (size + 5)
            })
            .attr("width", size)
            .attr("height", size)
            .style("fill", function (d) {
                return color(d)
            })

        svg.selectAll("mylabels")
            .data(keys)
            .enter()
            .append("text")
            .attr("x", 100 + size * 1.2)
            .attr("y", function (d, i) {
                return 55 + i * (size + 5) + (size / 2)
            })
            .style("fill", function (d) {
                return color(d)
            })
            .text(function (d) {
                return d
            })
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")

        // Create Tooltips
        tip = d3.tip().attr('class', 'd3-tip').direction('e').offset([0, 5])
            .html(function (d) {
                var content = "<span style='margin-left: 2.5px;'><b>" + d.label + "</b></span><br>";
                content += `
                    <table style="margin-top: 2.5px;">
                            <tr><td>Value: </td><td style="text-align: right">` + d.y + `</td></tr>
                    </table>
                    `;
                return content;
            });
        svg.call(tip);

        // Create "Notable Dates" lines
        svg.selectAll(".line")
            .data(notableDates)
            .enter()
            .append("line")
            .style("stroke", "black")
            //.attr("class", "dashed")
            .attr("x1", function (d) {
                return xScale(d.date);
            })
            .attr("y1", 0)
            .attr("x2", function (d) {
                return xScale(d.date);
            })
            .attr("y2", height)

        topSvg.selectAll(".line")
            .data(notableDates)
            .enter()
            .append("line")
            .style("stroke", "black")
            //.attr("class", "dashed")
            .attr("x1", function (d) {
                return xScale(d.date);
            })
            .attr("y1", function(d,i) {
                return topSvgHeight/2 + (i * 11)
            })
            .attr("x2", function (d) {
                return xScale(d.date);
            })
            .attr("y2", topSvgHeight)

        topSvg.selectAll("notableDatesTitles")
            .data(notableDates)
            .enter()
            .append("text")
            .attr("class", "notableDates")
            .attr("x", function(d) {
                return xScale(d.date) + 1
            })
            .attr("y", function(d,i) {
                return (topSvgHeight/2 + (i * 11)) + 11
            })
            .text(function (d) {
                return d.label
            })
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")

        // Add bar chart
        updateChart();
    });

    function getReportForDate(data, reportDate) {
        for (var i = 0; i < data.length; i++) {
            if (data[i].reportDate === reportDate) {
                return i;
            }
        }

        return data.length - 1;
    }

    function updateChart() {
        var idx = getReportForDate(theData, dataTime[sliderTime.value()]);
        var deathData = svg.selectAll(".deathbar")
            .data(theData[idx].deathsPerDay);
        var casesData = svg.selectAll(".casebar")
            .data(theData[idx].casesPerDay);

        var deathEnter = deathData.enter();
        var casesEnter = casesData.enter();

        casesEnter.append("rect")
            .attr("class", "casebar")
            .attr("x", function (d) {
                return xScale(d.label);
            })
            .attr("y", function (d) {
                return yScale(d.y);
            })
            .attr("height", function (d) {
                return height - yScale(d.y);
            })
            .attr("width", xScale.bandwidth())
            .style("fill", colors[0])
            .on("mouseover", function (d, i) {
                handleCaseMouseOver(d, i, d3.select(this))
            })
            .on("mouseout", function (d, i) {
                handleCaseMouseOut(d, i, d3.select(this))
            });

        deathEnter.append("rect")
            .attr("class", "deathbar")
            .attr("id", function (d) {
                return d.label + "-deaths"
            })
            .attr("x", function (d) {
                return xScale(d.label);
            })
            .attr("y", function (d) {
                return yScale(d.y);
            })
            .attr("height", function (d) {
                return height - yScale(d.y);
            })
            .attr("width", xScale.bandwidth())
            .style("fill", colors[1])
            .on("mouseover", function (d, i) {
                handleDeathMouseOver(d, i, d3.select(this))
            })
            .on("mouseout", function (d, i) {
                handleDeathMouseOut(d, i, d3.select(this))
            });


        casesData.transition().duration(100)
            .attr("y", function (d) {
                return yScale(d.y);
            })
            .attr("height", function (d) {
                return height - yScale(d.y);
            });

        deathData.transition().duration(100)
            .attr("y", function (d) {
                return yScale(d.y);
            })
            .attr("height", function (d) {
                return height - yScale(d.y);
            });

        deathData.exit().remove();
        casesData.exit().remove();

        // Ensure notable dates lines are on top!
        svg.selectAll("line").moveToFront();
    }

    // Create Event Handlers for mouse
    function handleDeathMouseOver(d, i, d3This) {
        d3This.style("fill", colors[3]);
        tip.show(d, i);
    }

    function handleDeathMouseOut(d, i, d3This) {
        d3This.style("fill", colors[1]);
        tip.hide(d, i);
    }

    function handleCaseMouseOver(d, i, d3This) {
        d3This.style("fill", colors[2]);
        tip.show(d, i);
    }

    function handleCaseMouseOut(d, i, d3This) {
        d3This.style("fill", colors[0]);
        tip.hide(d, i);
    }
</script>
</body>
</html>