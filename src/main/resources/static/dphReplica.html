<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GA Interactive Epicurve</title>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    
    <link href="epicurveInteractive.css" rel="stylesheet">

</head>
<body>
<script src="d3-simple-slider.min.js"></script>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"/>

<div class="site-wrapper">
    <div class="masthead clearfix">
        <h3 class="masthead-brand">Unofficial COVID-19 Interactive Epicurve for Georgia</h3>
    </div>
    
    <div class="row align-items-center">
        <div class="col-sm-2">Selected Snapshot<p id="value-time"></p></div>
        <div class="col-sm">
            <div id="slider-time"></div>
        </div>
        <div class="col-sm" id="timestamp">Lastest update:&nbsp
            <div class="col-sm">
                <div id="update-timestamp"></div>
            </div>
        </div>
    </div>
    
    <div id="graphContent"></div>
    
    <div class="footer"></div>
</div>

<!-- Load c3.css -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.15/c3.min.css" rel="stylesheet">

<!-- Load d3.js and c3.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.15/c3.min.js"></script>

<script>
    let chartData, timeData, sliderTime, chart, prevSliderValue;
    prevSliderValue = 0;
    
    d3.json("/reports/v2/daily").then(function (data) {
        // Slider!
        createSlider(data);
        
        let initialConvertedData = convertSingleApiContent(data[data.length-1]);
        let prelimStartDate = initialConvertedData[0][initialConvertedData[0].length-14];
        
        d3.select('div#update-timestamp').text(data[data.length-1].id);

        chart = c3.generate({
            bindto: '#graphContent',
            data: {
                x: 'Curve Dates',
                columns: initialConvertedData,
                selection: {
                    enabled: true
                },
                axes: {
                   Deaths: 'y2'
                },
                hide: ['Projected Cases','Deaths']
            },
            transition: {
                duration: 100
            },
            size: {
                height: 600
            },
            padding: {
                top: 20,
                bottom: 20
            },
            color: {
                pattern: ['#35a5ff', '#ff0000', '#597994', '#ff7f0e']
            },
            grid: {
                x: {
                    focus: {
                        show: true
                    },
                    lines: [
                        {value: '2020-03-23', text: 'Large Gathering Ban', position: 'start'},
                        {value: '2020-04-02', text: 'Shelter In Place', position: 'start', class: 'label-5'},
                        {value: '2020-05-01', text: 'Shelter In Place Expired For Majority', position: 'start'}
                    ]
                },
                y: {
                    focus: {
                        show: true
                    }
                }
            },
            axis: {
                x: {
                    type: 'timeseries',
                    tick: {
                        //format: '%Y-%m-%d',
                        //rotate: -90,
                        culling: {
                            max: 20
                        }
                    },
                    label: "Date"
                },
                y: {
                    label: "Confirmed Cases",
                    max: 1200
                },
                y2: {
                    label: "Deaths",
                    max: 70,
                    show: true
                }
            },
            regions: [{axis: 'x', start: prelimStartDate, class: 'prelim-region', label: '14-day Window', vertical: true}],
            line: {
                connectNull: true
            }
        });
        
        chartData = convertAllApiContent(data);
    });
    
    function updatePreliminaryRegion(prelimStartDate) {
        console.log("setting prelim-region to " + prelimStartDate.toISOString().substring(0,10))
        chart.regions.remove({classes: ['prelim-region']});
        chart.regions.add(
            [
                {axis: 'x', start: prelimStartDate.toISOString().substring(0,10), class: 'prelim-region', label: '14-day Window', vertical: true}
            ]
        );
        chart.flush();
        let regionWidth = d3.select('.prelim-region').attr('width');
        let regionX = d3.select('.prelim-region').attr('x');
        d3.selectAll('.prelim-region').selectAll('rect').attr('width', regionWidth).attr('x', regionX);
        d3.selectAll('.prelim-region').selectAll('text').attr('y', regionX);
        chart.flush();
    }
    
    function updateAllCharts(data, currentDate) {
        updatePreliminaryRegion(currentDate);
        chart.load({
            columns: data
        });
    }

    /**
     * Returns a dictionary of dates to report.
     */
    function convertAllApiContent(data) {
        let fullArray = [];
        let targetDateCount = data[data.length-1].curveDates.length;
        
        data.map(function(d) {
            fullArray.push(convertSingleApiContentNoDates(d, targetDateCount));
        });

        return fullArray;
    }

    /**
     * Convert json response to the multi-dimensional array that C3 supports.
     *
     * @param data the raw json response from API
     */
    function convertSingleApiContent(data) {
        let dates = ['Curve Dates'].concat(data.curveDates);
        let cases = ['Cases'].concat(data.cases);
        let deaths = ['Deaths'].concat(data.deaths);
        let caseProjections = ['Projected Cases'].concat(data.caseProjections);
        let movingAvgs = ['7 Day Moving Average'].concat(data.movingAvgs);

        return [dates, cases, deaths, caseProjections, movingAvgs];
    }
    
    function convertSingleApiContentNoDates(data, targetDateCount) {
        let padding = [];
        if (targetDateCount) {
            padding = new Array(targetDateCount - data.cases.length).fill().map((_, i) => 0);
        }
        
        let cases = ['Cases'].concat(data.cases).concat(padding);
        let deaths = ['Deaths'].concat(data.deaths).concat(padding);
        let caseProjections = ['Projected Cases'].concat(data.caseProjections).concat(padding);
        let movingAvgs = ['7 Day Moving Average'].concat(data.movingAvgs).concat(padding);

        return [cases, deaths, caseProjections, movingAvgs];
    }


    function createSlider(data) {
        timeData = data.map(function (d) {
            return d.reportDate;
        });
        
        sliderTime = d3
            .sliderBottom()
            //.min(-1 * (timeData.length - 1))
            //.max(0)
            .domain([-42, 0])
            .marks([-42, 0])
            .step(1)
            //.ticks(5)
            .width(350)
            .tickValues([0, -7, -14, -21, -28, -35, -42])
            .on('onchange', val => {
                //console.log("previous slider:" + prevSliderValue + "Math.round(val):" + Math.round(val) + " current slider: " + val);
                if (Math.abs(Math.round(val) - Math.round(prevSliderValue)) >= 1) {
                    //console.log("previous slider:" + prevSliderValue + " current slider: " + val);
                    let currentDate = getReverseIdxValue(timeData, val);
                    let currentChartData = getReverseIdxValue(chartData, val);
                    d3.select('p#value-time').text(currentDate);
                    let currentDateObj = new Date(currentDate);
                    currentDateObj.setDate(currentDateObj.getDate()-13)
                    updateAllCharts(currentChartData, currentDateObj);
                    prevSliderValue = Math.round(val);
                }
            });

        var gTime = d3
            .select('div#slider-time')
            .append('svg')
            .attr('width', 400)
            .attr('height', 100)
            .append('g')
            .attr('transform', 'translate(30,30)');

        gTime.call(sliderTime);

        d3.select('p#value-time').text(getReverseIdxValue(timeData, sliderTime.value()));
    }

    /**
     * Gets the value from the provided array as if it were indexed from the end. So 0 gets the last element, and -data.length-1 gets the first element.
     * -1 Gets the next to the last element.
     */
    function getReverseIdxValue(data, idx) {
        return data[data.length - 1 + idx];
    }

</script>
</body>
</html>