<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GA Interactive Epicurve</title>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    
    <link href="epicurveInteractive.css" rel="stylesheet">

</head>
<body>
<script src="d3-simple-slider.min.js"></script>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"/>

<div class="site-wrapper">
    <div class="container theme-showcase" role="main">
        <div class="row">
            <div class="masthead clearfix col-md-8">
                <h3 class="masthead-brand">Unofficial COVID-19 Interactive Epicurve for Georgia</h3>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-2">Selected Snapshot<p id="value-time"></p></div>
            <div class="col-md-8">
                <div id="slider-time"></div>
            </div>
            <div class="col-md-2" id="timestamp">Lastest update:&nbsp
                <div>
                    <div id="update-timestamp"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="graphContent"></div>
    
    <div class="footer"></div>
</div>

<!-- Load d3.js and c3.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js" charset="utf-8"></script>

<script>
    let chartData, summaryData, sliderTime, chart;
    let prevSliderValue = 0;
    let deltaEnabled = false;

    // set the dimensions of the canvas
    var margin = {top: 0, right: 20, bottom: 120, left: 60},
        width = 1000 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom

    // set the ranges
    var dphxScale = d3.scaleBand().rangeRound([0, width]);

    var dphyScale = d3.scaleLinear().range([height, 0]);

    // define the axis
    var dphxAxis = d3.axisBottom(dphxScale);

    var dphyAxis = d3.axisLeft(dphyScale).ticks(10);

    var dphSvg = d3.select("#graphContent").append("svg")
        .attr("id", "dphSvg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    Promise.all([
        d3.csv("reports/v2/summary.csv"),
        d3.csv("reports/v2/cases.csv"),
        d3.csv("reports/v2/deaths.csv"),
    ]).then(function (files) {
        summaryData = files[0];
        chartData = parseChartData(summaryData, files[1], files[2]);
        let latestSummary = summaryData[summaryData.length - 1];
        let latestDate = latestSummary.reportDate;

        console.log("Got files! files[0].length: " + summaryData.length + ", files[1].length: " + chartData.length);
        console.log("latestDate: " + latestDate)

        d3.select('div#update-timestamp').text(latestSummary.id);

        // Slider!
        createSlider(summaryData);

        // Axis should be set to the latest data.
        // scale the range of the data
        dphxScale.domain(getLastElement(chartData).map(function (d) {
            return d.label;
        }));
        dphyScale.domain([0, getYScale(getLastElement(chartData))]);
        drawAxisLines();

        // add DPH axis
        createAxis(dphSvg, dphxAxis, dphyAxis, height);
    });

    function getLastElement(data) {
        let keySet = Object.keys(data);
        return data[keySet[keySet.length - 1]];
    }

    function parseChartData(summaryData, caseData, deathData) {
        let tempChartData = [];

        for (let i = 0; i < summaryData.length; i++) {
            let currentSummaryData = summaryData[i];
            let currentCaseData = caseData[i];
            let currentDeathData = deathData[i];
            let currentReportDates = Object.keys(currentCaseData).filter(function (d) {
                return d !== 'id'
            });
            let currentTimeseries = tempChartData[currentSummaryData.id];
            if (!currentTimeseries) {
                currentTimeseries = [];
                tempChartData[currentSummaryData.id] = currentTimeseries;
            }
            currentReportDates.forEach(function (d) {
                currentTimeseries.push({
                    label: d,
                    cases: +currentCaseData[d],
                    deaths: +currentDeathData[d]
                });
            });
        }

        return tempChartData;
    }

    function updateAllCharts(data, prelimDate) {
        console.log("Updating chart for prelim date " + prelimDate);

    }

    function make_y_gridlines() {
        return d3.axisLeft(dphyScale).tickValues([0, 100, 200, 300, 400, 500, 600, 700, 800, 900])
    }

    function drawAxisLines() {
        dphSvg.selectAll(".grid").remove();
        dphSvg.append("g")
            .attr("class", "grid")
            .call(make_y_gridlines()
                .tickSize(-width)
                .tickFormat("")
            );
    }

    function createXAxisTickValues() {
        let epicurve = getLastElement(chartData);
        let xAxisTickValues = [];

        for (let i = 0; i < epicurve.length; i += 2) {
            xAxisTickValues.push(epicurve[i].label);
        }

        return xAxisTickValues;
    }

    function createAxis(parent, xAxis, yAxis, height) {
        parent.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis.tickValues(createXAxisTickValues()))
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", "-.55em")
            .attr("transform", "rotate(-90)");

        parent.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 5)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Cases Per Day");
    }

    function getYScale(data) {
        if (deltaEnabled) {
            return 300;
        }

        return d3.max(data, function (d) {
            return d.cases;
        })
    }

    function createSlider(data) {
        let timeData = data.map(function (d) {
            return d.reportDate;
        });

        sliderTime = d3
            .sliderBottom()
            //.min(-1 * (timeData.length - 1))
            //.max(0)
            .domain([-42, 0])
            .marks([-42, 0])
            .step(1)
            //.ticks(5)
            .width(350)
            .tickValues([0, -7, -14, -21, -28, -35, -42])
            .on('onchange', val => {
                //console.log("previous slider:" + prevSliderValue + "Math.round(val):" + Math.round(val) + " current slider: " + val);
                if (Math.abs(Math.round(val) - Math.round(prevSliderValue)) >= 1) {
                    //console.log("previous slider:" + prevSliderValue + " current slider: " + val);
                    let currentDate = getReverseIdxValue(timeData, Math.round(val));
                    let currentChartData = getReverseIdxValue(chartData, Math.round(val));
                    d3.select('p#value-time').text(currentDate);
                    let currentDateObj = new Date(currentDate);
                    currentDateObj.setDate(currentDateObj.getDate() - 13)
                    updateAllCharts(currentChartData, currentDateObj);
                    prevSliderValue = Math.round(val);
                }
            });

        var gTime = d3
            .select('div#slider-time')
            .append('svg')
            .attr('width', 400)
            .attr('height', 100)
            .append('g')
            .attr('transform', 'translate(30,30)');

        gTime.call(sliderTime);

        d3.select('p#value-time').text(getReverseIdxValue(timeData, sliderTime.value()));
    }

    /**
     * Gets the value from the provided array as if it were indexed from the end. So 0 gets the last element, and -data.length-1 gets the first element.
     * -1 Gets the next to the last element.
     */
    function getReverseIdxValue(data, idx) {
        return data[data.length - 1 + idx];
    }

</script>
</body>
</html>