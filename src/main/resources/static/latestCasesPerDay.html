<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>COVID-19 Stats</title>
    <style>

        .bar {
            fill: steelblue;
            shape-rendering: crispEdges;
        }

        .bar:hover {
            fill: brown;
            shape-rendering: crispEdges;
        }

        .axis {
            font: 10px sans-serif;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

    </style>

</head>
<body>
<script src="https://d3js.org/d3.v5.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>

<link
        rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous"
/>

<div class="container">
    <h2>COVID-19 Confirmed Cases Per Day</h2>
    <div class="row align-items-center">
        <div class="col-sm-2"><p id="value-time"></p></div>
        <div class="col-sm">
            <div id="slider-time"></div>
        </div>
    </div>
</div>

<script>
    var keys = ["Confirmed Cases", "Deaths"];
    var colors = ["#8a89a6", "#ff8c00"];

    // set the dimensions of the canvas
    var margin = {top: 20, right: 20, bottom: 120, left: 60},
        width = 1000 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;


    // set the ranges
    var xScale = d3.scaleBand().rangeRound([0, width]);

    var yScale = d3.scaleLinear().range([height, 0]);

    // define the axis
    var xAxis = d3.axisBottom(xScale);


    var yAxis = d3.axisLeft(yScale).ticks(10);


    // add the SVG element
    var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    var theData, dataTime, sliderTime;

    // load the data
    d3.json("/reports/daily").then(function (data) {
        // Set slider data
        dataTime = data.map(function (d) {
            return d.reportDate;
        });

        sliderTime = d3
            .sliderBottom()
            .min(14) // Just so happens that the 14th record is the first one with data...
            .max(dataTime.length-1)
            .step(1)
            .ticks(dataTime.length-1-14)
            .width(350)
            //.tickValues(dataTime)
            .on('onchange', val => {
                d3.select('p#value-time').text(dataTime[val]);
                updateChart();
            });

        var gTime = d3
            .select('div#slider-time')
            .append('svg')
            .attr('width', 400)
            .attr('height', 100)
            .append('g')
            .attr('transform', 'translate(0,30)');

        gTime.call(sliderTime);

        d3.select('p#value-time').text(dataTime[sliderTime.value()]);



        // Do the graph!

        theData = data;
        var casesPerDay = data[data.length - 1].casesPerDay;

        // scale the range of the data
        xScale.domain(casesPerDay.map(function (d) {
            return d.label;
        }));
        yScale.domain([0, d3.max(casesPerDay, function (d) {
            return d.y;
        })]);

        // add axis
        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", "-.55em")
            .attr("transform", "rotate(-90)");

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 5)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Cases Per Day");

        // Legend
        var color = d3.scaleOrdinal()
            .domain(keys)
            .range(colors);

        var size = 10
        svg.selectAll("mydots")
            .data(keys)
            .enter()
            .append("rect")
            .attr("x", 100)
            .attr("y", function(d,i){ return 100 + i*(size+5)})
            .attr("width", size)
            .attr("height", size)
            .style("fill", function(d){ return color(d)})

        svg.selectAll("mylabels")
            .data(keys)
            .enter()
            .append("text")
            .attr("x", 100 + size*1.2)
            .attr("y", function(d,i){ return 105 + i*(size+5) + (size/2)})
            .style("fill", function(d){ return color(d)})
            .text(function(d){ return d})
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")


        // Add bar chart
        updateChart();

    });

    function getReportForDate(data, reportDate) {
        for (var i = 0; i < data.length; i++) {
            if (data[i].reportDate === reportDate) {
                return i;
            }
        }

        return data.length-1;
    }

    function updateChart() {
        var idx = getReportForDate(theData, dataTime[sliderTime.value()]);
        var deathData = svg.selectAll(".deathbar")
            .data(theData[idx].deathsPerDay);
        var casesData = svg.selectAll(".casebar")
            .data(theData[idx].casesPerDay);

        var deathEnter = deathData.enter();
        var casesEnter = casesData.enter();

        casesEnter.append("rect")
            .attr("class", "casebar")
            .attr("x", function (d) {
                return xScale(d.label);
            })
            .attr("y", function (d) {
                return yScale(d.y);
            })
            .attr("height", function (d) {
                return height - yScale(d.y);
            })
            .attr("width", xScale.bandwidth())
            .style("fill", colors[0])
            .on("mouseover", handleMouseOver)
            .on("mouseout", handleMouseOut);

        deathEnter.append("rect")
            .attr("class", "deathbar")
            .attr("x", function (d) {
                return xScale(d.label);
            })
            .attr("y", function (d) {
                return yScale(d.y);
            })
            .attr("height", function (d) {
                return height - yScale(d.y);
            })
            .attr("width", xScale.bandwidth())
            .style("fill", colors[1])
            .on("mouseover", handleMouseOver)
            .on("mouseout", handleMouseOut);


        casesData.transition().duration(100)
            .attr("y", function (d) {
                return yScale(d.y);
            })
            .attr("height", function (d) {
                return height - yScale(d.y);
            });

        deathData.transition().duration(100)
            .attr("y", function (d) {
                return yScale(d.y);
            })
            .attr("height", function (d) {
                return height - yScale(d.y);
            });

        deathData.exit().remove();
        casesData.exit().remove();
    }

    // Create Event Handlers for mouse
    function handleMouseOver(d, i) {  // Add interactivity

        // Specify where to put label of text
        svg.append("text").attr({
            id: "t" + d.label + "-" + d.y + "-" + i,  // Create an id for text so we can select it later for removing on mouseout
            x: function () {
                return xScale(d.label);
            },
            y: function () {
                return yScale(d.y) - 15;
            }
        })
            .text(function () {
                return [d.label, d.y];  // Value of the text
            });
    }

    function handleMouseOut(d, i) {

        // Select text by id and then remove
        d3.select("#t" + d.label + "-" + d.y + "-" + i).remove();  // Remove text location
    }
</script>
</body>
</html>